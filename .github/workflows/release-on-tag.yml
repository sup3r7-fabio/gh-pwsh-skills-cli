name: Release on Semver Tags

on:
  push:
    tags:
      # Stable releases: v1.0.0, v2.1.3, etc.
      - 'v[0-9]+.[0-9]+.[0-9]+'
      # Pre-releases: v1.0.0-beta.1, v1.0.0-alpha.2, v1.0.0-rc.1
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+'
      # Development releases: v1.0.0-dev.20231106, v1.0.0-nightly.123
      - 'v[0-9]+.[0-9]+.[0-9]+-dev.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-nightly.[0-9]+'

env:
  GO_VERSION: '1.25.3'

jobs:
  validate-tag:
    name: Validate Semver Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      is_prerelease: ${{ steps.validate.outputs.is_prerelease }}
      release_type: ${{ steps.validate.outputs.release_type }}
      config_file: ${{ steps.validate.outputs.config_file }}
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Validate and parse semver tag
      id: validate
      run: |
        set -euo pipefail
        
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "Processing tag: $TAG_NAME"
        
        # Validate semver format using regex
        if [[ ! $TAG_NAME =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)(-([a-zA-Z0-9]+)\.([0-9]+))?$ ]]; then
          echo "âŒ Invalid semver tag format: $TAG_NAME"
          echo "Expected formats:"
          echo "  Stable: v1.2.3"
          echo "  Pre-release: v1.2.3-beta.1, v1.2.3-alpha.1, v1.2.3-rc.1"
          echo "  Development: v1.2.3-dev.123, v1.2.3-nightly.456"
          exit 1
        fi
        
        # Extract version components
        FULL_VERSION=${TAG_NAME#v}
        BASE_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
        PRERELEASE_TYPE="${BASH_REMATCH[5]:-}"
        PRERELEASE_NUMBER="${BASH_REMATCH[6]:-}"
        
        echo "Parsed version:"
        echo "  Full: $FULL_VERSION"
        echo "  Base: $BASE_VERSION" 
        echo "  Prerelease Type: ${PRERELEASE_TYPE:-'(none)'}"
        echo "  Prerelease Number: ${PRERELEASE_NUMBER:-'(none)'}"
        
        # Determine release type and configuration
        if [ -z "$PRERELEASE_TYPE" ]; then
          # Stable release
          RELEASE_TYPE="stable"
          IS_PRERELEASE="false"
          CONFIG_FILE=".goreleaser.yml"
          echo "ğŸ¯ Release Type: Stable Release"
        else
          # Pre-release
          IS_PRERELEASE="true"
          case "$PRERELEASE_TYPE" in
            alpha)
              RELEASE_TYPE="alpha"
              CONFIG_FILE=".goreleaser.beta.yml"
              echo "ğŸ§ª Release Type: Alpha Release"
              ;;
            beta)
              RELEASE_TYPE="beta" 
              CONFIG_FILE=".goreleaser.beta.yml"
              echo "ğŸ§ª Release Type: Beta Release"
              ;;
            rc)
              RELEASE_TYPE="release-candidate"
              CONFIG_FILE=".goreleaser.yml"
              echo "ğŸš€ Release Type: Release Candidate"
              ;;
            dev)
              RELEASE_TYPE="development"
              CONFIG_FILE=".goreleaser.beta.yml" 
              echo "âš¡ Release Type: Development Release"
              ;;
            nightly)
              RELEASE_TYPE="nightly"
              CONFIG_FILE=".goreleaser.beta.yml"
              echo "ğŸŒ™ Release Type: Nightly Release"
              ;;
            *)
              echo "âŒ Unsupported prerelease type: $PRERELEASE_TYPE"
              echo "Supported types: alpha, beta, rc, dev, nightly"
              exit 1
              ;;
          esac
        fi
        
        # Validate version progression (optional check with error handling)
        LATEST_STABLE_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname 2>/dev/null | grep -v '-' | head -n1 || echo "v0.0.0")
        echo "Latest stable tag: $LATEST_STABLE_TAG"
        
        # Set outputs
        echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version_number=$FULL_VERSION" >> $GITHUB_OUTPUT  
        echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT
        echo "prerelease_type=$PRERELEASE_TYPE" >> $GITHUB_OUTPUT
        
        echo "âœ… Tag validation successful!"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: validate-tag
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Run tests
      run: go test -v ./...
      
    - name: Build
      run: go build -v ./...

  release:
    name: Create Release
    needs: [validate-tag, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Validate GoReleaser config
      run: |
        CONFIG_FILE="${{ needs.validate-tag.outputs.config_file }}"
        echo "Checking GoReleaser config: $CONFIG_FILE"
        
        if [[ ! -f "$CONFIG_FILE" ]]; then
          echo "âŒ GoReleaser config file not found: $CONFIG_FILE"
          echo "Available files:"
          ls -la .goreleaser* 2>/dev/null || echo "No .goreleaser files found"
          exit 1
        fi
        
        echo "âœ… GoReleaser config validated: $CONFIG_FILE"

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v5
      with:
        distribution: goreleaser
        version: latest
        args: release --clean --config ${{ needs.validate-tag.outputs.config_file }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release summary
      run: |
        VERSION="${{ needs.validate-tag.outputs.version }}"
        RELEASE_TYPE="${{ needs.validate-tag.outputs.release_type }}"
        IS_PRERELEASE="${{ needs.validate-tag.outputs.is_prerelease }}"
        
        echo "ğŸ‰ RELEASE CREATED: $VERSION"
        echo "================================"
        echo "ğŸ“‹ Type: $RELEASE_TYPE"
        echo "ğŸ·ï¸  Prerelease: $IS_PRERELEASE"
        echo ""
        
        case "$RELEASE_TYPE" in
          stable)
            echo "âœ… STABLE RELEASE - Ready for production!"
            echo "ğŸ“¦ Install: gh extension install sup3r7-fabio/gh-pwsh-skills"
            ;;
          alpha)
            echo "ğŸ§ª ALPHA RELEASE - Early testing version"
            echo "ğŸ“¦ Install: gh extension install sup3r7-fabio/gh-pwsh-skills@$VERSION"
            echo "âš ï¸  Warning: Alpha releases may be unstable"
            ;;
          beta)
            echo "ğŸ§ª BETA RELEASE - Feature complete, testing needed"  
            echo "ğŸ“¦ Install: gh extension install sup3r7-fabio/gh-pwsh-skills@$VERSION"
            echo "âš ï¸  Warning: Beta releases may have bugs"
            ;;
          release-candidate)
            echo "ğŸš€ RELEASE CANDIDATE - Final testing before stable"
            echo "ğŸ“¦ Install: gh extension install sup3r7-fabio/gh-pwsh-skills@$VERSION"
            ;;
          development)
            echo "âš¡ DEVELOPMENT RELEASE - Latest development build"
            echo "ğŸ“¦ Install: gh extension install sup3r7-fabio/gh-pwsh-skills@$VERSION"
            echo "âš ï¸  Warning: Development releases are unstable"
            ;;
          nightly)
            echo "ğŸŒ™ NIGHTLY RELEASE - Automated nightly build"
            echo "ğŸ“¦ Install: gh extension install sup3r7-fabio/gh-pwsh-skills@$VERSION"
            echo "âš ï¸  Warning: Nightly releases are experimental"
            ;;
        esac
        
        echo ""
        echo "ğŸ”— Release: https://github.com/sup3r7-fabio/gh-pwsh-skills/releases/tag/$VERSION"
        echo "ğŸ“Š Actions: https://github.com/sup3r7-fabio/gh-pwsh-skills/actions"

  notify:
    name: Notify Release
    needs: [validate-tag, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Success notification
      if: needs.release.result == 'success'
      run: |
        echo "âœ… Release ${{ needs.validate-tag.outputs.version }} published successfully!"
        echo "ğŸ¯ Type: ${{ needs.validate-tag.outputs.release_type }}"
        
    - name: Failure notification  
      if: needs.release.result == 'failure'
      run: |
        echo "âŒ Release failed for tag ${{ needs.validate-tag.outputs.version }}"
        echo "Check logs: https://github.com/sup3r7-fabio/gh-pwsh-skills/actions"
